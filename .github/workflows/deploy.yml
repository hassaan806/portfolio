  # ---------------- Developed by Yousuf Kalim - MERN TL ---------------- #
# CI/CD workflow to deploy a React.js frontend to a remote Ubuntu server
# using GitHub Actions, SCP, and SSH.
#
# Key points:
# - Builds React app with yarn.
# - Transfers build folder to the remote server using SCP.
# - Stores NGINX config in the build folder on the remote server.
# - Restarts NGINX after deployment.
# - Designed for dev environment (push events) or workflow_dispatch input.
# - No symbolic links are created; root access is required for /root path.
# --------------------------------------------------------------------- #

name: 'CD'

# ----------------------------- Environment Variables ----------------------------- #
env:
  # Application name (e.g., portfolio)
  APP_NAME: ${{ vars.APP_NAME }}

  # Component name (e.g., frontend)
  COMPONENT_NAME: ${{ vars.COMPONENT_NAME }}

  # Release path on remote server:
  # For push events → dev environment
  # For workflow_dispatch → user-provided environment
  RELEASE_PATH: /root/${{ vars.APP_NAME }}/${{ github.event_name == 'push' && 'dev' || github.event.inputs.environment }}/${{ vars.COMPONENT_NAME }}

  # Node environment (used for selecting secrets dynamically)
  NODE_ENV: ${{ github.event_name == 'push' && 'dev' || github.event.inputs.environment }}
# ------------------------------------------------------------------------------- #

# ----------------------------- Trigger Events ----------------------------- #
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (dev, staging, preprod, prod)'
        type: choice
        options:
          - dev
        required: true
# ------------------------------------------------------------------------- #

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # -------------------- Step 1: Checkout Code -------------------- #
      - name: Checkout code
        uses: actions/checkout@v2
        # Retrieves the latest code from the repository

      # -------------------- Step 2: Setup Node.js -------------------- #
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16
        # Sets up Node.js environment for building the React app

      # -------------------- Step 3: Install Dependencies & Build -------------------- #
      - name: Install deps and build project
        run: |
          yarn install         # Installs dependencies
          CI= yarn run build   # Builds React app into 'build/' folder

      # -------------------- Step 4: Transfer Build Files to Server -------------------- #
      - name: Transfer files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets[format('{0}_SERVER', env.NODE_ENV)] }}
          username: ${{ secrets[format('{0}_USER', env.NODE_ENV)] }}
          key: ${{ secrets[format('{0}_KEY', env.NODE_ENV)] }}
          rm: true                 # Remove remote folder before copying
          source: 'build'          # Local build folder
          target: ${{ env.RELEASE_PATH }}/build
        # This copies the build folder to the remote server at:
        # /root/APP_NAME/ENV/COMPONENT_NAME/build

      # -------------------- Step 5: Copy NGINX Config & Cleanup -------------------- #
      - name: Copy config files
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets[format('{0}_SERVER', env.NODE_ENV)] }}
          username: ${{ secrets[format('{0}_USER', env.NODE_ENV)] }}
          key: ${{ secrets[format('{0}_KEY', env.NODE_ENV)] }}
          script: |
            # Move nested build folder to main build folder (if exists)
            mv ${{ env.RELEASE_PATH }}/build/build/* ${{ env.RELEASE_PATH }}/build/ || true
            rm -rf ${{ env.RELEASE_PATH }}/build/build || true

            # Write NGINX config from secrets into the build folder
            echo '${{ secrets[format('{0}_NGINX', env.NODE_ENV)] }}' > ${{ env.RELEASE_PATH }}/build/nginx.conf

            # Restart NGINX to apply changes
            sudo systemctl restart nginx

        # Notes:
        # - The NGINX config is kept inside the build folder as requested.
        # - Root access is required to restart NGINX.
        # - Adjust this script if deploying to non-root directories.
# ------------------------------------------------------------------------- #
